<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>دادرس هوشمند — چت حقوقی</title>
  <style>
    :root { --bg:#0b0f19; --panel:#0f1526; --text:#e5e7eb; --muted:#94a3b8; --accent:#6366f1; --accent-2:#22d3ee; --border:#1f2937; --shadow:0 8px 24px rgba(0,0,0,.25); }
    .light { --bg:#f8fafc; --panel:#ffffff; --text:#0f172a; --muted:#64748b; --accent:#4f46e5; --accent-2:#06b6d4; --border:#e2e8f0; --shadow:0 8px 24px rgba(0,0,0,.08); }
    *{ box-sizing:border-box }
    html, body{ height:100%; }
    body{ margin:0; background:radial-gradient(1200px 600px at 80% -10%, #14203a 0, transparent 60%), var(--bg); color:var(--text); font-family: ui-sans-serif,system-ui,"Segoe UI",Tahoma; line-height:1.9 }
    .header{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border); position:sticky; top:0; background:color-mix(in oklab, var(--bg) 92%, transparent); backdrop-filter:saturate(1.2) blur(10px); z-index:20 }
    .brand{ font-weight:900; letter-spacing:.2px; background:linear-gradient(135deg,var(--accent),var(--accent-2)); -webkit-background-clip:text; background-clip:text; color:transparent; font-size:16px }
    .theme{ appearance:none; background:transparent; border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:12px; cursor:pointer; transition:transform .15s ease, background .2s ease; display:none }
    .hamb{ appearance:none; background:transparent; border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:12px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; gap:6px }
    .hamb .line{ width:18px; height:2px; background:var(--text); border-radius:2px; position:relative }
    .hamb .line::before, .hamb .line::after{ content:""; position:absolute; left:0; width:18px; height:2px; background:var(--text); border-radius:2px }
    .hamb .line::before{ top:-6px }
    .hamb .line::after{ top:6px }
    .theme:hover{ transform:translateY(-1px) }
    .main{ min-height:100dvh; display:flex; flex-direction:column }
    .chatWrap{ flex:1; overflow-y:auto; }
    .chat{ width:100%; max-width:820px; margin:0 auto; padding:14px; display:flex; flex-direction:column; gap:12px }
    .bubble{ display:flex; gap:10px; align-items:flex-start; max-width:85%; border:1px solid var(--border); border-radius:16px; background:color-mix(in oklab, var(--panel) 96%, transparent); padding:12px 12px; box-shadow:var(--shadow) }
    .bubble .content{ flex:1; }
    .bubble p{ margin:0; line-height:1.85 }
    .user{ align-self:flex-start; border-color:#2b3346; background:color-mix(in oklab, var(--panel) 94%, transparent) }
    .bot{ align-self:flex-end; border-color:#243048; background:color-mix(in oklab, var(--panel) 98%, transparent) }
    .avatar{ width:34px; height:34px; border-radius:50%; flex:0 0 34px; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:13px; }
    .avatar.u{ background:linear-gradient(135deg,#22d3ee,#4f46e5); color:#0b1020 }
    .avatar.b{ background:linear-gradient(135deg,#8b5cf6,#22d3ee); color:#0b1020 }
    .bot .meta, .user .meta{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px }
    .typing{ display:flex; align-items:center; gap:6px }
    .typing .dot{ width:6px; height:6px; border-radius:50%; background:var(--muted); opacity:.5; animation: blink 1.2s infinite }
    .typing .dot:nth-child(2){ animation-delay:.2s }
    .typing .dot:nth-child(3){ animation-delay:.4s }
    @keyframes blink{ 0%{opacity:.2} 20%{opacity:1} 100%{opacity:.2} }
    .composer{ position:sticky; bottom:0; border-top:1px solid var(--border); background:color-mix(in oklab, var(--bg) 94%, transparent); padding:12px; padding-bottom:calc(14px + env(safe-area-inset-bottom)); backdrop-filter:saturate(1.1) blur(8px); box-shadow:0 -10px 30px rgba(0,0,0,.15) }
    .compose{ width:100%; max-width:820px; margin:0 auto; display:grid; grid-template-columns:1fr auto; gap:10px; background:color-mix(in oklab, var(--panel) 96%, transparent); border:1px solid var(--border); border-radius:16px; padding:8px }
    textarea.input{ min-height:56px; resize:vertical; border:0; border-radius:12px; padding:12px; background:transparent; color:var(--text); outline:none }
    textarea.input:focus{ box-shadow:inset 0 0 0 2px color-mix(in oklab, var(--accent) 35%, transparent) }
    button.send{ background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#0b1020; font-weight:800; border:0; padding:12px 18px; border-radius:999px; cursor:pointer; transition:transform .15s ease, opacity .2s ease }
    button.send:hover{ transform:translateY(-1px) }
    button.send:disabled{ opacity:.6; cursor:not-allowed; transform:none }
    /* Icon-sized send button for mobile-first UI */
    .sendicon{ width:48px; height:48px; padding:0; border-radius:14px; display:inline-flex; align-items:center; justify-content:center }
    .sendicon svg{ display:block }
    @media (max-width: 480px){
      .compose{ gap:6px; padding:6px }
      textarea.input{ min-height:52px; font-size:14px }
      .sendicon{ width:46px; height:46px; border-radius:12px }
    }
    .hint{ width:100%; max-width:820px; margin:6px auto 0; color:var(--muted); font-size:12px; display:flex; align-items:center; gap:8px }
    .kbd{ border:1px solid var(--border); background:color-mix(in oklab, var(--panel) 96%, transparent); padding:2px 6px; border-radius:6px; font-size:11px }
    .muted{ color:var(--muted); font-size:12px }
    .topmeta{ max-width:980px; margin:10px auto 0; padding:0 20px }
    a.link{ color:var(--accent); text-decoration:none }
    .footer{ position:sticky; bottom:0; border-top:1px solid var(--border); background:color-mix(in oklab, var(--bg) 94%, transparent); padding:12px 18px; padding-bottom:calc(12px + env(safe-area-inset-bottom)); backdrop-filter:saturate(1.1) blur(6px) }
    /* Draft card */
    .card{ width:100%; max-width:820px; margin:10px auto 0; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--shadow) }
    .grid2{ display:grid; grid-template-columns:1fr; gap:10px }
    @media (min-width: 900px){ .grid2{ grid-template-columns:1fr 1fr } }
    .inputx, .textareax{ width:100%; padding:8px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text) }
    .textareax{ min-height:80px }
    /* Layout with sidebar */
    .layout{ display:grid; grid-template-columns:1fr; min-height:100dvh }
    /* Mobile-first: full-screen drawer */
    .sidebar{ position:fixed; inset:0; width:100vw; height:100vh; transform:translateX(-100%); border-inline-end:1px solid var(--border); background:color-mix(in oklab, var(--panel) 92%, var(--bg)); padding:16px; z-index:100; overflow:auto; transition:transform .28s ease; backdrop-filter:saturate(1.2) blur(10px) }
    .sbtitle{ font-weight:800; margin:0 0 8px; color:var(--muted) }
    .sbhead{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px }
    .sbclose{ appearance:none; background:transparent; border:1px solid var(--border); color:var(--text); padding:6px 10px; border-radius:10px; cursor:pointer }
    @media (min-width:1024px){ .sbclose{ display:none } }
    .nav{ display:flex; flex-direction:column; gap:8px }
    .navlink{ appearance:none; background:transparent; color:var(--text); text-align:start; padding:10px 12px; border:1px solid var(--border); border-radius:10px; cursor:pointer }
    .navlink:hover{ border-color:color-mix(in oklab, var(--accent) 60%, var(--border)) }
    .content{ display:flex; flex-direction:column }
    .sidebar.open{ transform:none }
    @media (min-width: 1024px){ .layout{ grid-template-columns:280px 1fr } .sidebar{ position:sticky; inset:auto; width:auto; height:100dvh; transform:none; top:0; box-shadow:none; z-index:40 } }
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:90 }
    .overlay.show{ opacity:1; pointer-events:auto }
    .hamb.open .line{ background:transparent }
    .hamb.open .line::before{ top:0; transform:rotate(45deg) }
    .hamb.open .line::after{ top:0; transform:rotate(-45deg) }
    .no-scroll, body.no-scroll{ overflow:hidden; height:100% }
    /* Swipe edge (mobile) */
    #edgeOpen{ position:fixed; inset:0 auto 0 0; width:28px; z-index:35; background:transparent }
    @media (min-width:1024px){ #edgeOpen{ display:none } }
  </style>
</head>
<body>
  <div class="header">
    <div class="brand">دادرس هوشمند</div>
    <div>
      <button id="toggleSidebar" class="hamb" aria-label="منو"><span class="line"></span></button>
    </div>
  </div>
  <div id="overlay" class="overlay"></div>
  <div id="edgeOpen" aria-hidden="true"></div>
  <div class="topmeta muted" id="ctxMeta"></div>
  <div class="layout">
    {% include 'partials/sidebar.html' %}
    <main class="content">
      <div class="main" id="main">
    <div id="draftCard" class="card" style="display:none">
      <h3 style="margin:0 0 10px">پیش‌نویس لایحه</h3>
      <div class="grid2">
        <div>
          <label class="muted">عنوان پرونده</label>
          <input id="c_title" class="inputx" />
          <div class="grid2" style="margin-top:10px">
            <div>
              <label class="muted">خواهان</label>
              <input id="c_p_plaintiff" class="inputx" />
            </div>
            <div>
              <label class="muted">خوانده</label>
              <input id="c_p_defendant" class="inputx" />
            </div>
          </div>
          <div style="margin-top:10px">
            <label class="muted">مرجع رسیدگی</label>
            <input id="c_court" class="inputx" />
          </div>
          <div style="margin-top:10px">
            <label class="muted">ادعا/خواسته</label>
            <textarea id="c_claims" class="textareax"></textarea>
          </div>
          <div style="margin-top:10px">
            <label class="muted">وقایع</label>
            <textarea id="c_facts" class="textareax"></textarea>
          </div>
          <div style="margin-top:10px">
            <label class="muted">درخواست نهایی</label>
            <textarea id="c_requests" class="textareax" style="min-height:60px"></textarea>
          </div>
          <div style="margin-top:10px">
            <button id="draftBtn" class="send">تولید پیش‌نویس</button>
            <button id="downloadDocxBtn" class="theme" style="margin-inline-start:6px" disabled>دانلود DOCX</button>
            <button id="sendDraftBtn" class="theme" style="margin-inline-start:6px" disabled>ارسال به چت</button>
            <span id="draftStatus" class="muted" style="margin-right:8px"></span>
          </div>
        </div>
        <div>
          <label class="muted">پیش‌نمایش لایحه</label>
          <pre id="draftPreview" class="textareax" style="white-space:pre-wrap; border:1px dashed var(--border)">—</pre>
          <div style="margin-top:10px">
            <label class="muted">استنادات بازیابی‌شده</label>
            <pre id="draftCitations" class="textareax" style="white-space:pre-wrap; border:1px dashed var(--border); min-height:100px">—</pre>
          </div>
        </div>
      </div>
    </div>
    <div class="chatWrap" id="chatWrap">
      <div id="chat" class="chat">
        <div class="bubble bot">
          <div class="avatar b">د</div>
          <div class="content">
            <span class="meta">دستیار</span>
            <p><b>سلام! من «دادرس هوشمند» هستم.</b> برای کمک در امور حقوقی کنار شما هستم؛ از <b>تحلیل حقوقی</b> و <b>تنظیم پیش‌نویس لایحه/دادخواست</b> تا یافتن استنادات مرتبط.
            <br/>
            <small class="muted">سلب مسئولیت: محتوای ارائه‌شده صرفاً جنبهٔ راهنمایی عمومی دارد و جایگزین مشاورهٔ تخصصی یا وکالت نیست. لطفاً پیش از اقدام نهایی، با اهل فن مشورت کنید.</small>
            <br/>
            بفرمایید، در چه موردی کمکتان کنم؟</p>
            <div id="suggests" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px">
              <button id="sDraft" class="theme">نوشتن لایحه</button>
              <button id="sAnalysis" class="theme">تحلیل حقوقی</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="compose">
        <textarea id="question" class="input" placeholder="سؤال خود را بنویسید..."></textarea>
        <button id="askBtn" class="send sendicon" aria-label="ارسال">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" aria-hidden="true">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
          </svg>
        </button>
      </div>
      <div class="hint">
        <span>می‌توانید با میانبر</span>
        <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span>
        <span>سریع ارسال کنید.</span>
      </div>
    </div>
    </main>
  </div>
  <script>
  const $ = (id) => document.getElementById(id);
  const scrollBox = $('chatWrap');
  function scrollToBottom(){
    if(!scrollBox) return;
    // به انتهای لیست پیام‌ها اسکرول کن
    scrollBox.scrollTop = scrollBox.scrollHeight;
  }
  function addMsg(role, text){
    const chat = $('chat');
    const div = document.createElement('div');
    div.className = 'bubble ' + (role === 'user' ? 'user' : 'bot');
    const avatar = document.createElement('div');
    avatar.className = 'avatar ' + (role === 'user' ? 'u' : 'b');
    avatar.textContent = role === 'user' ? 'ش' : 'د';
    const wrap = document.createElement('div');
    wrap.className = 'content';
    const who = document.createElement('span'); who.className = 'meta'; who.textContent = role === 'user' ? 'شما' : 'دستیار';
    const p = document.createElement('p'); p.textContent = text;
    wrap.appendChild(who); wrap.appendChild(p);
    div.appendChild(avatar); div.appendChild(wrap);
    chat.appendChild(div);
    scrollToBottom();
  }
  async function refreshCtxMeta(){
    try{
      const r = await fetch('/context');
      if(!r.ok) return;
      const d = await r.json();
      const meta = $('ctxMeta');
      meta.textContent = `متن‌های سشن: ${d.count}`;
    }catch{}
  }
  async function send(){
    const qEl = $('question');
    const q = qEl.value.trim();
    if(!q) return;
    addMsg('user', q);
    qEl.value = '';
    const chat = $('chat');
    const typing = document.createElement('div');
    typing.className = 'bubble bot typing';
    typing.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    chat.appendChild(typing);
    scrollToBottom();
    const askBtn = $('askBtn');
    askBtn.disabled = true;
    try{
      const res = await fetch('/ask', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ question:q, context:'' }) });
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      const data = ct.includes('application/json') ? await res.json() : { error: await res.text() };
      chat.lastElementChild.remove();
      if(!res.ok) throw new Error(data.error||'خطا');
      addMsg('bot', data.answer || 'پاسخی دریافت نشد.');
    }catch(e){
      chat.lastElementChild.remove();
      addMsg('bot', 'خطا: ' + e.message);
    }finally{ askBtn.disabled = false; refreshCtxMeta(); }
  }
  $('askBtn').addEventListener('click', send);
  $('question').addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); send(); }});
  // تم از طریق آیتم سایدبار کنترل می‌شود (navTheme)
  refreshCtxMeta();
  // اطمینان از اسکرول به انتها در تغییر اندازهٔ ویوپورت (مخصوصاً موبایل)
  if (window.visualViewport && typeof window.visualViewport.addEventListener === 'function') {
    window.visualViewport.addEventListener('resize', scrollToBottom);
  } else {
    window.addEventListener('resize', scrollToBottom);
  }
  // پس از بارگذاری اولیه نیز به انتها برو
  scrollToBottom();

  // پیش‌نویس لایحه (سمت کاربر)
  const btnToggleDraft = document.getElementById('toggleDraft');
  if (btnToggleDraft) btnToggleDraft.addEventListener('click', ()=>{
    const box = $('draftCard');
    const show = box.style.display !== 'none';
    box.style.display = show ? 'none' : 'block';
  });
  $('draftBtn').addEventListener('click', async ()=>{
    const st = $('draftStatus');
    st.textContent = 'در حال تولید...';
    $('downloadDocxBtn').disabled = true;
    $('sendDraftBtn').disabled = true;
    try{
      const caseObj = {
        title: $('c_title').value.trim(),
        court: $('c_court').value.trim(),
        parties: { خواهان: $('c_p_plaintiff').value.trim(), خوانده: $('c_p_defendant').value.trim() },
        claims: $('c_claims').value.trim(),
        facts: $('c_facts').value.trim(),
        requests: $('c_requests').value.trim()
      };
      const res = await fetch('/draft', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ case: caseObj }) });
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      const data = ct.includes('application/json') ? await res.json() : { error: await res.text() };
      if(!res.ok) throw new Error(data.error||'خطای ناشناخته');
      $('draftPreview').textContent = data.draft || '—';
      $('draftCitations').textContent = (data.citations||[]).map((c,i)=>`${i+1}) [${c.score}] ${c.snippet}`).join('\n') || '—';
      st.textContent = 'آماده دانلود.';
      $('downloadDocxBtn').disabled = !(data && data.draft);
      $('sendDraftBtn').disabled = !(data && data.draft);
      // بلافاصله متن لایحه را نیز در چت نمایش بده
      if (data && data.draft) {
        addMsg('bot', data.draft);
      }
    }catch(e){ st.textContent = 'خطا: ' + e.message }
  });
  $('sendDraftBtn').addEventListener('click', ()=>{
    const text = $('draftPreview').textContent || '';
    if (text && text !== '—') {
      addMsg('bot', text);
    }
  });
  $('downloadDocxBtn').addEventListener('click', async ()=>{
    const st = $('draftStatus');
    st.textContent = 'در حال ساخت فایل...';
    try{
      const draft = $('draftPreview').textContent;
      const res = await fetch('/draft/docx', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ draft }) });
      if(!res.ok){ throw new Error(await res.text() || 'خطا در ساخت DOCX'); }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'draft.docx'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      st.textContent = 'دانلود شد.';
    }catch(e){ st.textContent = 'خطا: ' + e.message }
  });
  // پیشنهادات شروع سریع
  const sDraft = document.getElementById('sDraft');
  const sAnalysis = document.getElementById('sAnalysis');
  if (sDraft) sDraft.addEventListener('click', ()=>{
    const box = $('draftCard');
    box.style.display = 'block';
    addMsg('bot', 'برای نوشتن لایحه، جزئیات پرونده را در فرم بالا وارد کنید و روی «تولید پیش‌نویس» بزنید.');
    scrollToBottom();
  });
  if (sAnalysis) sAnalysis.addEventListener('click', ()=>{
    $('question').value = 'لطفاً یک تحلیل حقوقی کوتاه از موضوع زیر ارائه بده: ';
    $('question').focus();
  });
  // سایدبار
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');
  const hambBtn = document.getElementById('toggleSidebar');
  const closeBtn = document.getElementById('closeSidebar');
  function setSidebar(open){
    if(!sidebar || !overlay || !hambBtn) return;
    sidebar.classList.toggle('open', open);
    overlay.classList.toggle('show', open);
    hambBtn.classList.toggle('open', open);
    document.documentElement.classList.toggle('no-scroll', open);
    document.body.classList.toggle('no-scroll', open);
  }
  if (hambBtn) hambBtn.addEventListener('click', ()=> setSidebar(!sidebar.classList.contains('open')));
  if (overlay) overlay.addEventListener('click', ()=> setSidebar(false));
  if (closeBtn) closeBtn.addEventListener('click', ()=> setSidebar(false));
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && sidebar && sidebar.classList.contains('open')) setSidebar(false); });
  const navChat = document.getElementById('navChat');
  if (navChat) navChat.addEventListener('click', ()=>{
    setSidebar(false);
    document.getElementById('chat').scrollIntoView({ behavior:'smooth', block:'start' });
  });
  const navDraft = document.getElementById('navDraft');
  if (navDraft) navDraft.addEventListener('click', ()=>{
    setSidebar(false);
    const box = $('draftCard'); box.style.display = 'block';
    box.scrollIntoView({ behavior:'smooth', block:'start' });
  });
  // تغییر تم از منو
  const navTheme = document.getElementById('navTheme');
  function applyThemeButton(){ if(!navTheme) return; const isLight=document.documentElement.classList.contains('light'); navTheme.textContent = isLight ? 'حالت تاریک' : 'حالت روشن'; }
  if (navTheme) navTheme.addEventListener('click', ()=>{ const isLight=document.documentElement.classList.toggle('light'); localStorage.setItem('theme', isLight ? 'light' : 'dark'); applyThemeButton(); setSidebar(false); });
  (function initTheme2(){ const saved=localStorage.getItem('theme')||'dark'; if(saved==='light') document.documentElement.classList.add('light'); applyThemeButton(); })();
  // Gestures: swipe from left to open; swipe left to close
  let touchStartX=0, touchStartY=0, touchActive=false;
  const OPEN_THRESHOLD = 28, CLOSE_THRESHOLD = -28, VERT_TOL = 60;
  function onTouchStart(e){
    const t = e.touches ? e.touches[0] : e;
    touchStartX = t.clientX || t.pageX;
    touchStartY = t.clientY || t.pageY;
    // اجازه شروع ژست از هر نقطه (درخواست کاربر)
    touchActive = true;
  }
  function onTouchMove(e){
    if(!touchActive) return;
    const t = e.touches ? e.touches[0] : e;
    const dx = (t.clientX||t.pageX) - touchStartX;
    const dy = Math.abs((t.clientY||t.pageY) - touchStartY);
    if(dy > VERT_TOL) return; // بی‌اثر برای اسکرول عمودی
    if(!sidebar.classList.contains('open') && dx > OPEN_THRESHOLD) setSidebar(true);
    if(sidebar.classList.contains('open') && dx < CLOSE_THRESHOLD) setSidebar(false);
  }
  function onTouchEnd(){ touchActive = false; }
  // Window-level gestures
  window.addEventListener('touchstart', onTouchStart, { passive:true });
  window.addEventListener('touchmove', onTouchMove, { passive:true });
  window.addEventListener('touchend', onTouchEnd, { passive:true });
  // Edge zone for reliable open
  const edge = document.getElementById('edgeOpen');
  if (edge){
    edge.addEventListener('click', ()=> setSidebar(true));
    edge.addEventListener('touchstart', onTouchStart, { passive:true });
    edge.addEventListener('touchmove', onTouchMove, { passive:true });
    edge.addEventListener('touchend', onTouchEnd, { passive:true });
  }
  // پیش‌بارگذاری و نمایش درصد
  async function refreshProgress(){
    try{
      const r = await fetch('/ingest-progress');
      const d = await r.json();
      const pct = d.percent || 0;
      const bar = document.getElementById('ingestBar');
      const txt = document.getElementById('ingestTxt');
      if (bar) bar.style.width = pct + '%';
      if (txt) txt.textContent = pct + '%';
    }catch{}
  }
  const btnRefresh = document.getElementById('refreshProgBtn');
  if (btnRefresh) btnRefresh.addEventListener('click', refreshProgress);
  const btnPrewarm = document.getElementById('prewarmBtn');
  if (btnPrewarm) btnPrewarm.addEventListener('click', async ()=>{
    try{
      await fetch('/ingest-prewarm', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ dir:'pdf', fast:true, max_files:20 }) });
      refreshProgress();
    }catch{}
  });
  if (btnRefresh || btnPrewarm) setInterval(refreshProgress, 5000);
  </script>
</body>
</html>

